---
title: "rocker/r-verとかのアップデートをちょっと自動化した話"
author: "eitsupi"
date: "2021/07/03"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      countIncrementalSlides: false
---

# @eitsupi

.center[![eitsupi](./image/eitsupi.jpg)]

- R歴二年くらい
- Docker歴一年くらい
  - [データサイエンス100本ノック（構造化データ加工編）](https://github.com/The-Japan-DataScientist-Society/100knocks-preprocess)でDockerに初めて触る。
- 日本語版WindowsのShift-JISとの戦いに疲れ果て、DockerおよびWSL2を常用するように。

---

# Docker（Linuxコンテナ）を使うメリット

- 環境構築かんたん。
  - Dockerさえセットアップすればどのマシンでも同じように動く（多分）。
- 日本語版WindowsでもShift-JISの呪いから解放される。

---

# rocker/r-verとは？

- （後述の派生含めて）よく使われるRのコンテナイメージのひとつ
- GitHubリポジトリは[rocker-org/rocker-versioned2](https://github.com/rocker-org/rocker-versioned2)
- Docker Official Imagesの[r-base](https://hub.docker.com/_/r-base)との比較
  - DebianにaptでRをインストールしている`r-base`に対し、`rocker/r-ver`はUbuntu上でRをソースコードからビルドしてインストールしている
  - デフォルトでRStudio Package ManagerからバイナリのRパッケージをインストールするためパッケージのインストールが早い  
  （※CRANはWindowsとMacOSにはバイナリパッケージを提供しているがLinuxはソースのみなので通常はインストールに時間がかかる）
  - よく使われるIDEであるRStudio Serverやtidyverse等のパッケージ群を`rocker/r-ver`上にインストール済のイメージも一緒に提供されている（`rocker/rstudio`、`rocker/tidyverse`）
  - 様々なアーキテクチャでビルドされている`r-base`と異なり`rocker/r-ver`には（現状）amd64イメージしかない
  - Docker Official Imagesの安心感（？）はないが、`r-base`のDockerfileもrocker-orgがメンテしているので大差ない（？）

---

# rocker/r-verのレシピ

`rocker/r-ver`は再現性を重視しており、古いバージョンのRのイメージでは「そのバージョンのRが最新だった時代のパッケージをインストールする」という挙動をとる。

これはほぼ毎日CRANのミラーを取得しているRSPM（R3.6.3以前はMRAN）の特定の日付のミラーをCRANとして使用することで実現している。

だいたい以下のようなルールでDockefileが作られている。

1. そのバージョンのRがリリースされた時点で最新のUbuntu LTSをベースイメージにする。
2. そのバージョンのRが最新だった最後の日のRSPMのCRANミラーをデフォルトのRパッケージリポジトリにする。
3. （明言されていないが）RStudioもそのバージョンのRが最新だったときの最新バージョンで固定する。

---

# 問題

- RやRStudioのリリース時に手作業でDockefileのアップデートやイメージのビルドを行っているため最新バージョンをすぐに試せない
- 実質一人でメンテナンスしているため変数の設定ミス多発（一年前のCRANのスナップショットに固定されていたり……）

---

# 自動化したい！

誰が設定しても同じ値になるようなレシピなのだから自動化できるはず！

---

# Rのリリース日

`rversions::r_versions`関数によりRのSVNリポジトリ <https://svn.r-project.org/R/tags/> から良い感じに取得可能（よく分かってません……）

```{r}
rversions::r_versions() |>
  tail()
```

---

# Ubuntu LTSのリリース日

Ubuntuがローカルに持っているcsvファイルから取得可能

```{r}
read.csv("/usr/share/distro-info/ubuntu.csv") |>
  dplyr::select(version, series, release, eol, eol.esm) |>
  tail()
```
