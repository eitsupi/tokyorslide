---
title: >
  ã€ç‰¹å ±ã€‘<br/>
  <font color="crimson">Acero</font> å¯¾
  <font color="yellow">DuckDB</font> å¯¾
  <font color="gray">Pola</font><font color="orange">rs</font><br/>on
  <font color="royalblue">R</font>
subtitle: "2023-01-21 ç¬¬103å›Rå‹‰å¼·ä¼š@æ±äº¬<br/>@eitsupi"
format:
  revealjs:
    theme: [night, custom.scss]
    width: 1280
    height: 720
    slide-number: true
    chalkboard: false
    preview-links: auto
    footer: "#Tokyo.R"
    self-contained: true
    reference-location: document
lang: ja
---

# ã¯ã˜ã‚ã«

## è‡ªå·±ç´¹ä»‹

:::: {.columns}
::: {.column width="25%"}

![](../image/eitsupi.jpg){fig-align="center" width="300" height="300"}

:::
::: {.column width="75%"}

- [@eitsupi](https://twitter.com/eitsupi)
- ExcelãŒå«Œã«ãªã‚ŠRã‚’è§¦ã‚Šåˆã‚ã¦4å¹´å¼±
- Dockerã‚¤ãƒ¡ãƒ¼ã‚¸`rocker/r-ver`ä»–ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼
- æ˜¨æ—¥åˆRãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒCRANãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸğŸ‰

:::
::::

# 2022å¹´æœ«â€¦â€¦

---

:::: {.columns}

::: {.column width="50%"}

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">ã†ã‚ã‚ã‚ã‚ã‚ï¼<br>r-polarsãŒpola-rsçµ„ç¹”ã«ç§»å‹•ã—ã¨ã‚‹ï¼<a href="https://t.co/ITA4w6tOPF">https://t.co/ITA4w6tOPF</a></p>&mdash; ãˆã„ã¤ã´ (@eitsupi) <a href="https://twitter.com/eitsupi/status/1608013971428368385?ref_src=twsrc%5Etfw">December 28, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

:::

::: {.column width="50%"}

r-polarsè¥²æ¥ï¼

:::

::::

## Polarsã¨ã¯

- "Blazingly fast DataFrames in Rust, Python & Node.js"
  - å†…éƒ¨ã§Apache Arrowå½¢å¼ã‚’ä½¿ç”¨ã™ã‚‹Rustè£½ã®é«˜é€Ÿãªãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€‚
  - Rã®`data.table`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é«˜é€Ÿã•ã®ã‚¢ãƒ”ãƒ¼ãƒ«ã«ä½¿ç”¨ã•ã‚ŒãŸ[`h2oai/db-benchmark`](https://github.com/h2oai/db-benchmark)ï¼ˆæœ€çµ‚æ›´æ–°2021å¹´7æœˆï¼‰ã®æ•°ã€…ã®é …ç›®ã§Pythonç‰ˆpolarsãŒä¸Šä½ã«ã€‚
- ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã«ã‚ˆã‚‹åˆ†ã‹ã‚Šã‚„ã™ã„APIã€‚
- Windowsé–¢æ•°ãªã©ã‚‚åˆ©ç”¨å¯èƒ½ã§å¤šæ©Ÿèƒ½ã€‚

## h2oãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

![](h2o-bench.png){fig-align="center"}

å‡ºå…¸ï¼š<https://h2oai.github.io/db-benchmark/>, 2023å¹´1æœˆ21æ—¥é–²è¦§

# ã—ã‹ã—ãã‚Œã¯1å¹´åŠå‰ã®è©±â€¦â€¦

# Acero

## Aceroã¨ã¯

- 2021å¹´å½“æ™‚ã«ã¯åç„¡ã—ã ã£ãŸã€Apache Arrow C++ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¯ã‚¨ãƒªã‚¨ãƒ³ã‚¸ãƒ³ã€‚ï¼ˆä»Šå¾Œlibaceroã¨ã—ã¦åˆ†å‰²ã•ã‚Œãã†[^libacero]ï¼‰
- Rã®`arrow`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®`dplyr`APIã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚„ã¤ã€‚
- 2021å¹´ã®h2oãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œçµæœã«ã€ŒArrowã€ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã¯ã“ã‚Œã‚’æŒ‡ã—ã¦ã„ã‚‹ã€‚
  - â€¦â€¦ãŒã€å½“æ™‚ã¯`summarise`ã«ã‚‚`join`ã«ã‚‚å¯¾å¿œã—ã¦ã„ãªã‹ã£ãŸã®ã§ä½•ã‚‚ã—ã¦ãŠã‚‰ãšå…¨éƒ¨ç´ ã®`dplyr`ã§è¨ˆç®—ã•ã‚Œã¦ã„ãŸã¯ãšã€‚

[^libacero]: <https://github.com/apache/arrow/issues/15280>

# DuckDB

## DuckDBã¨ã¯

- SQLiteãƒ©ã‚¤ã‚¯ã«ä½¿ç”¨ã§ãã‚‹çµ„ã¿è¾¼ã¿å‘ã‘åˆ—æŒ‡å‘RDBMSã€‚
- å…¬å¼ã§Rã‚’å«ã‚€å¤šæ•°ã®è¨€èªã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ã€åºƒãä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã€‚Quartoã®`{ojs}`ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å†…ã§ã‚‚ä½•ã‚‚ã›ãšã«å‘¼ã¹ã‚‹ã€‚
- Postgresäº’æ›ã®SQLã‚’æ¡ç”¨ã€‚
  - ã€ŒFROMå¥ã‹ã‚‰å§‹ã¾ã‚‹ã‚¯ã‚¨ãƒªã€ã€ŒSELECTå†…ã§EXCLUDEã«ã‚ˆã‚‹åˆ—ã®é™¤å¤–ã€ãªã©ã®ä½¿ã„å‹æ‰‹æ”¹è‰¯ã«ã‚‚ç©æ¥µçš„ã€‚
- ã€Œãƒ“ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã¯æ­»ã‚“ã ã€‚ã‚¤ãƒ¼ã‚¸ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¸‡æ­³ã€[^big_data_is_dead]
- ã€Œã‚ãªãŸã®ãƒ©ãƒƒãƒ—ãƒˆãƒƒãƒ—ã¯ã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹ã‚ˆã‚Šã‚‚é«˜é€Ÿã§ã™ã€[^laptop_is_faster]

[^big_data_is_dead]: [Big Data is dead. Long live Easy Data.](https://motherduck.com/)
[^laptop_is_faster]: [Your laptop is faster than your data warehouse.Why wait for the cloud?](https://motherduck.com/)

## DuckDBLabsæ‰€å±ã®æ–¹ãŒãƒ•ã‚©ãƒ¼ã‚¯ã—ãŸ[^h2o-fork]h2oãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æœ€æ–°ã®çµæœ

[^h2o-fork]: <https://github.com/Tmonster/h2oai-db-benchmark>

![](h2o-bench-new.png){fig-align="center" height="400"}

å‡ºå…¸ï¼š<https://tmonster.github.io/h2oai-db-benchmark/>, 2023å¹´1æœˆ21æ—¥é–²è¦§

# on R

## é…å»¶è©•ä¾¡ã¨ãƒ—ãƒƒã‚·ãƒ¥ãƒ€ã‚¦ãƒ³

Parquetã«å¯¾ã™ã‚‹ã‚¯ã‚¨ãƒªã§ã¯é…å»¶è©•ä¾¡ã‚’è¡Œã„ä¸è¦ãªè¡Œã‚„åˆ—ã‚’èª­ã¿é£›ã°ã›ã‚‹ãŸã‚ã€CSVã‚’èª­ã¿è¾¼ã‚“ã§å‡¦ç†ã™ã‚‹å ´åˆã«æ¯”ã¹ã¦é«˜é€Ÿã‹ã¤çœãƒ¡ãƒ¢ãƒªã§å‡¦ç†ã‚’å®Œäº†ã§ãã‚‹ã€‚

ã„ã¤ã‚‚ã®Parquet[^parquet]ï¼ˆãŠã‚ˆã600ä¸‡è¡Œï¼‰ã§è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

[^parquet]: [DuckDB quacks Arrow: A zero-copy data integration between Apache Arrow and DuckDB](https://arrow.apache.org/blog/2021/12/03/arrow-duckdb/)

```r
curl::curl_download(
  "https://github.com/duckdb/duckdb-data/releases/download/v1.0/lineitemsf1.snappy.parquet",
  "lineitemsf1.snappy.parquet"
)
```

## Acero

```r
library(arrow, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)

open_dataset("lineitemsf1.snappy.parquet") |>
  filter(
    l_shipdate >= "1994-01-01",
    l_shipdate < "1995-01-01",
    l_discount >= 0.05,
    l_discount < 0.07,
    l_quantity < 24
  ) |>
  summarise(revenue = sum(l_extendedprice * l_discount, na.rm = TRUE)) |>
  collect()
```

## DuckDB

```r
library(duckdb)

con <- dbConnect(duckdb(), ":memory:")

query <- "
FROM
  'lineitemsf1.snappy.parquet'
SELECT
  SUM(l_extendedprice * l_discount) AS revenue
WHERE
  l_shipdate >= '1994-01-01'
  AND l_shipdate < '1995-01-01'
  AND l_discount >= 0.05
  AND l_discount < 0.07
  AND l_quantity < 24
"

dbGetQuery(con, query)
```

## DuckDB (dbplyr)

```r
library(duckdb)
library(dplyr, warn.conflicts = FALSE)
library(dbplyr, warn.conflicts = FALSE)

con <- dbConnect(duckdb(), ":memory:")

tbl(con, "lineitemsf1.snappy.parquet") |>
  filter(
    l_shipdate >= "1994-01-01",
    l_shipdate < "1995-01-01",
    l_discount >= 0.05,
    l_discount < 0.07,
    l_quantity < 24
  ) |>
  summarise(revenue = sum(l_extendedprice * l_discount, na.rm = TRUE)) |>
  collect()
```

## Polars

```r
library(rpolars)

scan_parquet("lineitemsf1.snappy.parquet")$filter(
  (pl$col("l_shipdate") >= "1994-01-01") &
    (pl$col("l_shipdate") < "1995-01-01") &
    (pl$col("l_discount") >= 0.05) &
    (pl$col("l_discount") < 0.07) &
    (pl$col("l_quantity") < 24)
)$select(
  (pl$col("l_extendedprice") * pl$col("l_discount"))$sum()$alias("revenue")
)$collect() |>
  as.data.frame()
```

# è¡æ’ƒã®çµæœ«ã‚’å›ã®ç›®ã§ç¢ºã‹ã‚ã‚ˆã†ï¼
