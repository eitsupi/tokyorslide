---
title: >
  新しいPolars Rパッケージの紹介
subtitle: "2025-12-06 Japan.R 2025<br/>@eitsupi"
format:
  revealjs:
    theme: night
    width: 1280
    height: 720
    slide-number: true
    chalkboard: false
    preview-links: auto
    footer: "#Japan.R 2025"
    # embed-resources: true
    reference-location: document
execute:
  cache: true
  echo: true
lang: ja
---

# はじめに

## 自己紹介

:::: {.columns}

::: {.column width="25%"}

![](../image/eitsupi.jpg){fig-align="center" width="300" height="300"}

:::

::: {.column width="75%"}

- [@eitsupi](https://github.com/eitsupi)
- 本業：手料理サブスク [つくりおき.jp](https://www.tsukurioki.jp/) の  
  　　　データ基盤周り（dbt）
- 副業：[Columnar社](https://columnar.tech/)でADBC周りのお手伝い
- Excelが嫌になりRを使い始めて6年
  - [Rockerプロジェクト (Shell, R, Docker)](https://rocker-project.org/)
  - [Polars Rパッケージ (R, Rust)](https://pola-rs.github.io/r-polars/)
  - [PRQL (Rust, R, Python)](https://prql-lang.org/)

:::

::::

# 前回までのあらすじ

---

発表するの久しぶりなので、  
関連するこれまでの発表を振り返ってみましょう！

::: {.incremental}

- 2022年03月 Tokyo.R [arrowパッケージの紹介](https://eitsupi.github.io/tokyorslide/tokyor_97/)
- 2022年07月 Tokyo.R [dtplyrパッケージの紹介](https://eitsupi.github.io/tokyorslide/tokyor_100/)
- 2023年01月 Tokyo.R [polarsパッケージの紹介](https://eitsupi.github.io/tokyorslide/tokyor_103lt/)
- 2023年06月 Tokyo.R [DuckDBの紹介](https://eitsupi.github.io/tokyorslide/tokyor_106/)
- 2023年12月 Japan.R [polarsパッケージの紹介](https://eitsupi.github.io/tokyorslide/japanr2023/)
- 2024年06月 Tokyo.R [duckplyrパッケージの紹介](https://eitsupi.github.io/tokyorslide/tokyor_113/)

:::

. . .

<div style="text-align: right;">

あの人いつもdplyr周りの話してる……。

</div>

---

## 本日話すこと

1年かけてpolarsパッケージを完全に書き直したので[^etienne][^polars0]、  
改めて紹介したい！

::: {.incremental}

[^etienne]: 1人でやったわけではなく、[Etienne Bacherさん](https://github.com/etiennebacher)もめっちゃ作業してくださった。
[^polars0]: 旧実装からそのままコピーしただけの部分もある。

- RでPolarsを使ってみる
  - Python Polars風構文
  - dplyrバックエンド
- 技術的な話
  - clockパッケージのサポート
  - mirai/reticulate統合
  - S7

:::

# Polarsについて

---

## Polars

::: {.incremental}

- 「最速のデータフレームライブラリの一つ」
- Rust製
- 内部データはApache Arrow形式
- Pythonパッケージがpandasとの比較で有名
  - 公式パッケージ　：Python、Rust
  - 非公式パッケージ：Nodo.js、R、Ruby
- 現在はPolars社（オランダ）が本体を開発

:::

---

## R Polars

::: {.incremental}

- Rust PolarsのRバインディング
  - APIはRust PolarsではなくPython Polarsを模倣する方針
    - そのせいでRの行数が……（R 5万行超、Rust 1万行超）
- 依存Rパッケージ（必須）：rlang、S7
  - 旧R Polarsは依存パッケージなしに拘っていたが、  
    辛過ぎたので「rlang依存しないとヤダヤダ」と私が駄々をこねた
  - S7については後述
  - 加えて、vctrs、blob、hmsもほぼ必須
- Rust側依存関係：polars、savvy、flume

:::

---

（良い感じのベンチマーク結果を入れたかったページ）

. . .

```{.default .center}
#> # A tibble: 7 × 6
#>   expression             min   median `itr/sec` mem_alloc `gc/sec`
#>   <bch:expr>        <bch:tm> <bch:tm>     <dbl> <bch:byt>    <dbl>
#> 1 acero_dplyr        149.7ms  156.1ms      6.25   41.83MB     0
#> 2 duckdb_dbplyr      109.4ms  113.7ms      8.35   24.18MB     2.09
#> 3 duckdb_duckplyr     62.8ms   69.1ms     14.4     3.71MB     0
#> 4 duckdb              59.6ms   61.5ms     14.9      4.9KB     0
#> 5 sedonadb            56.8ms   73.1ms     13.6      6.7MB     0
#> 6 polars_tidypolars   62.4ms   67.2ms     13.5    13.15MB     2.26
#> 7 polars                50ms   53.2ms     18.8    99.51KB     0
```

<div style="text-align: right;">

[2025-12-01に公開した記事より](https://zenn.dev/eitsupi/articles/r-polars-2025)

</div>

先んじてZennに記事を投稿済なので、そちらをご確認ください！

# RでPolarsを使ってみる

---

:::: {.columns}

::: {.column width="50%"}

### Python

```python
import polars as pl
import polars.selectors as cs

pl.DataFrame(
    {
        "x": [1, 2, 3],
        "y": ["a", "b", "c"],
    }
).select(cs.by_name("x"))
```

:::

::: {.column width="50%"}

### R

```r
library(polars)

pl$DataFrame(
  x = c(1, 2, 3),
  y = c("a", "b", "c"),
)$select(cs$by_name("x"))
```

:::

::::

. . .

<div style="text-align: right;">

何その構文！？

</div>

## Python Polarsを模倣する意味

# Base R S3メソッド

# dplyr/tidyr S3メソッド

## tidypolars

- dplyrバックエンド
- 多数のパッケージの関数を、dplyr動詞内で使用可能にする
  - 動詞内の関数を検出し、polarsの式に置き換える  
    （dbplyrやarrowパッケージに類似）

# 余談： インストール

## MSRV問題

- R-multiverseを使いましょう

## Windows arm64

::: {.incremental}

- 昨日[^pr1684]からarm64版Windowsにも対応
  - 対応作業に時間をつかってしまい、  
    この資料を作るための貴重な時間が失われた……
  - バイナリパッケージ配布はR-universeにもないため、  
    以下のように`NOT_CRAN="true"`を設定し  
    自動バイナリダウンロードの有効化を推奨

    ```r
    Sys.setenv(NOT_CRAN = "true")
    install.packages('polars', repos = c("https://rpolars.r-universe.dev", getOption("repos")))
    ```

[^pr1684]: <https://github.com/pola-rs/r-polars/pull/1684>

:::

# 技術的な話

## mirai統合 / reticulate統合

- mirai：別のRセッション（同一マシン/別マシン）に  
  polarsオブジェクトを転送する
- reticulate：Pythonにpolarsオブジェクトを転送する

## S7採用

環境型にS3クラス属性を与えてメンバーを生やしたりしたもの
（R6クラスに類似）

```r
```

- 利点
  - 単純、依存関係なし
- 欠点
  - `is.environment()`が`TRUE`になる

---

```{r}
#| error: true
plot(polars::as_polars_df(mtcars))
```

↑のように謎のエラーが発生し、`plot()`関数を使えない。

. . .

- 関数内で`is.environment()`による判定が行われており、`as.data.frame()`まで到達できない。
  - arrowパッケージのクラスでも同じ（R6なので）。

---

## 多重ディスパッチ

::: {.incremental}

- 演算子

  ```r
  s <- polars::as_polars_series(1L)
  e <- polars::as_polars_expr(1L)

  s + 1 # 2 (Series)
  e + 1 # 2 (Expr)

  s + e # エラー
  e + s # エラー
  ```

- 複雑な関数

  ```r
  df <- polars::as_polars_df(mtcars)

  df[, 1]
  df[1]
  df[, "mpg"]
  df["mpg"]
  ```

:::
