---
title: >
  新しいPolars Rパッケージの紹介
subtitle: "2025-12-06 Japan.R 2025<br/>@eitsupi"
format:
  revealjs:
    theme: night
    width: 1280
    height: 720
    slide-number: true
    chalkboard: false
    preview-links: auto
    footer: "#Japan.R 2025"
    embed-resources: true
    reference-location: document
execute:
  cache: true
  echo: true
lang: ja
---

# はじめに

## 自己紹介

:::: {.columns}

::: {.column width="25%"}

![](../image/eitsupi.jpg){fig-align="center" width="300" height="300"}

:::

::: {.column width="75%"}

- [@eitsupi](https://github.com/eitsupi)
- 本業：手料理サブスク [つくりおき.jp](https://www.tsukurioki.jp/) の  
  　　　データ基盤周り（dbt）
- 副業：[Columnar社](https://columnar.tech/)でADBC周りのお手伝い
- Excelが嫌になりRを使い始めて6年
  - [Rockerプロジェクト (Shell, R, Docker)](https://rocker-project.org/)
  - [Polars Rパッケージ (R, Rust)](https://pola-rs.github.io/r-polars/)
  - [PRQL (Rust, R, Python)](https://prql-lang.org/)

:::

::::

# 前回までのあらすじ

---

久しぶりに発表させてもらうので、  
関連するこれまでの発表を振り返ってみましょう！

::: {.incremental}

- 2022年03月 Tokyo.R [arrowパッケージの紹介](https://eitsupi.github.io/tokyorslide/tokyor_97/)
- 2022年07月 Tokyo.R [dtplyrパッケージの紹介](https://eitsupi.github.io/tokyorslide/tokyor_100/)
- 2023年01月 Tokyo.R [polarsパッケージの紹介](https://eitsupi.github.io/tokyorslide/tokyor_103lt/)
- 2023年06月 Tokyo.R [DuckDBの紹介](https://eitsupi.github.io/tokyorslide/tokyor_106/)
- 2023年12月 Japan.R [polarsパッケージの紹介](https://eitsupi.github.io/tokyorslide/japanr2023/)
- 2024年06月 Tokyo.R [duckplyrパッケージの紹介](https://eitsupi.github.io/tokyorslide/tokyor_113/)

:::

. . .

<div style="text-align: right;">

あの人いつもdplyr周りの話してる……。

</div>

---

## 本日話すこと

1年かけてpolarsパッケージを完全に書き直したので[^etienne][^polars0]、  
改めて紹介したい！

::: {.incremental}

[^etienne]: 1人でやったわけではなく、[Etienne Bacherさん](https://github.com/etiennebacher)もめっちゃ作業してくださった。
[^polars0]: 旧実装からそのままコピーしただけの部分もある。

- RでPolarsを使ってみる
  - Python Polars風構文
  - S3メソッド（Base R、dplyr）
- 技術的な話
  - Rベクトルの型とArrow型の対応
  - mirai/reticulate統合
  - S7

:::

# Polarsについて

---

## Polars

::: {.incremental}

- 「最速のデータフレームライブラリの一つ」[^datafusion-doc]
- Rust製
- 内部データはApache Arrow形式
- Pythonパッケージがpandasとの比較で有名
  - 公式パッケージ　：Python、Rust
  - 非公式パッケージ：Nodo.js、R、Ruby
- 現在はPolars社（オランダ）が本体を開発

[^datafusion-doc]: _Polars is one of the fastest DataFrame libraries at the time of writing._  
  <https://datafusion.apache.org/user-guide/faq.html>,  
  2025-12-06閲覧

:::

---

## R Polars

::: {.incremental}

- Rust PolarsのRバインディング
  - APIはRust PolarsではなくPython Polarsを模倣する方針
    - そのせいでRの行数が……（R 5万行超、Rust 1万行超）
- 依存Rパッケージ（必須）：rlang、S7
  - 旧R Polarsは依存パッケージなしに拘っていたが、  
    辛過ぎたので「rlang依存しないとヤダヤダ」と私が駄々をこねた
  - S7については後述
  - 加えて、vctrs、blob、hmsもほぼ必須
- Rust側依存関係：polars、savvy、flume

:::

---

（良い感じのベンチマーク結果を入れたかったページ）

. . .

```{.default .center}
#> # A tibble: 7 × 6
#>   expression             min   median `itr/sec` mem_alloc `gc/sec`
#>   <bch:expr>        <bch:tm> <bch:tm>     <dbl> <bch:byt>    <dbl>
#> 1 acero_dplyr        149.7ms  156.1ms      6.25   41.83MB     0
#> 2 duckdb_dbplyr      109.4ms  113.7ms      8.35   24.18MB     2.09
#> 3 duckdb_duckplyr     62.8ms   69.1ms     14.4     3.71MB     0
#> 4 duckdb              59.6ms   61.5ms     14.9      4.9KB     0
#> 5 sedonadb            56.8ms   73.1ms     13.6      6.7MB     0
#> 6 polars_tidypolars   62.4ms   67.2ms     13.5    13.15MB     2.26
#> 7 polars                50ms   53.2ms     18.8    99.51KB     0
```

<div style="text-align: right;">
[2025-12-01に公開した記事より](https://zenn.dev/eitsupi/articles/r-polars-2025)
</div>

先んじてZennに記事を投稿済なので、そちらをご確認ください！

# RでPolarsを使ってみる

---

## Python Polars風構文

:::: {.columns}

::: {.column width="50%"}

### Python

```python
import polars as pl
import polars.selectors as cs

pl.DataFrame(
    {
        "x": [1, 2, 3],
        "y": ["a", "b", "c"],
    }
).select(cs.by_name("x"))
```

:::

::: {.column width="50%"}

### R

```r
library(polars)

pl$DataFrame(
  x = c(1, 2, 3),
  y = c("a", "b", "c"),
)$select(cs$by_name("x"))
```

:::

::::

. . .

<div style="text-align: right;">
何この構文！？
</div>

## Python Polars風構文

::: {.incremental}

- Rっぽくない
- お手本通りに作るだけなので（？）開発しやすい（？）[^python-like]
- PythonとRでほとんど同じ書き方をできて便利
  - 例：[(Pretty) big data wrangling with DuckDB and Polars](https://github.com/grantmcdermott/duckdb-polars)

[^python-like]: Rust側から自動生成されたRコードをもう一段階ラップしているため大変ではある。

:::

## Base R S3メソッド

:::: {.columns}

::: {.column width="50%"}

```r
df <- data.frame(
  x = c(1, 2, 3),
  y = c("a", "b", "c")
)

df["x"]
```

:::

::: {.column width="50%"}

```r
library(polars)

df <- data.frame(
  x = c(1, 2, 3),
  y = c("a", "b", "c")
) |>
  as_polars_df()

df["x"]
```

:::

::::

::: {.incremental}

- お馴染みの関数（の一部）を使える
- Polarsの全機能にアクセスできるわけではない
- 外部の関数で使用されることも想定される

:::

---

## dplyr / tidyr S3メソッド

:::: {.columns}

::: {.column width="50%"}

```r
tibble::tibble(
  x = c(1, 2, 3),
  y = c("a", "b", "c"),
) |>
  dplyr::select(x)
```

:::

::: {.column width="50%"}

```r
library(polars)
library(tidypolars)

tibble::tibble(
  x = c(1, 2, 3),
  y = c("a", "b", "c"),
) |>
  as_polars_df() |>
  dplyr::select(x)
```

:::

::::

::: {.incremental}

- tidypolarsパッケージによる提供
- dbplyrやarrow等のように、dplyr動詞だけなく  
  dplyr動詞内で評価される式の翻訳も行い、相当数の関数をサポート
- できることに差があるので、duckplyrやdbplyr + duckdbと比較して  
  使うのがオススメ

:::

## SQL

```r
library(polars)

ctx <- pl$SQLContext(
  dat =data.frame(
    x = c(1, 2, 3),
    y = c("a", "b", "c")
  )
)

ctx$execute("SELECT x FROM dat")$collect()
```

::: {.incremental}

- 地味にサポートされている
- そこまで機能が充実しているわけではなく開発の優先度も低いので  
  普通に考えるとduckdbの方が便利

:::

# 余談： インストール

## MSRV問題

- Minimum Supported Rust Version：ビルドに必要なRustバージョン
- CRAN上で利用可能なRustは非常に古く、polarsをビルドできない  
  → もちろんビルドできないためリリースもできない
- R-multiverseを使おう

## MSRV問題

```{r}
#| echo: false
#| fig-align: "center"
# すべてのGitタグからJSONファイルのURLを生成
json_urls <- gert::git_remote_ls(
  remote = "https://github.com/eitsupi/cran-rust-version.git"
) |>
  duckplyr::as_duckdb_tibble() |>
  dplyr::filter(
    grepl("^refs/tags/", ref)
  ) |>
  dplyr::mutate(
    url = paste0(
      "https://raw.githubusercontent.com/eitsupi/cran-rust-version/",
      ref,
      "/output/versions.json"
    ),
    .keep = "none"
  ) |>
  dplyr::pull(url)

# すべてのJSONファイルを読み込んで加工
json_data <- duckplyr::read_json_duckdb(
  json_urls,
  options = list(filename = TRUE)
) |>
  dplyr::mutate(
    date = dd$regexp_extract(filename, "[0-9]{4}-[0-9]{2}-[0-9]{2}")
  ) |>
  dplyr::mutate(date = as.Date(date)) |>
  dplyr::select(!filename) |>
  dplyr::group_by(date, flavor) |>
  tidyr::fill(tidyselect::everything()) |>
  dplyr::ungroup()

rust_versions <- duckplyr::read_file_duckdb(
  "https://raw.githubusercontent.com/rust-lang/rust/refs/heads/main/RELEASES.md",
  "read_text"
) |>
  dplyr::mutate(
    content = dd$regexp_split_to_table(content, "\n"),
    .keep = "none"
  ) |>
  dplyr::filter(grepl("^Version", content)) |>
  dplyr::mutate(
    version = dd$regexp_extract(content, "(Version )(.+)\\s+(\\(.*\\))", 2L),
    date = dd$regexp_extract(content, "([0-9]{4}-[0-9]{2}-[0-9]{2})"),
    .keep = "none"
  ) |>
  dplyr::filter(grepl(".+", version)) |>
  dplyr::mutate(date = as.Date(date)) |>
  dplyr::filter(
    suppressWarnings(smvr::as_smvr(version)) >= "1.70.0"
  )

json_data |>
  dplyr::rename(version = rustc) |>
  dplyr::union(dplyr::mutate(rust_versions, flavor = "rust")) |>
  dplyr::mutate(
    version = factor(
      version,
      levels = smvr::as_smvr(rust_versions$version) |> sort()
    )
  ) |>
  dplyr::select(date, flavor, version) |>
  ggplot2::ggplot(
    ggplot2::aes(x = date, y = version, group = flavor, color = flavor)
  ) +
  ggplot2::geom_step() +
  ggplot2::coord_cartesian(xlim = c(as.Date("2025-03-01"), NA)) +
  ggplot2::scale_x_date(labels = scales::label_date(format = "%Y-%m-%d")) +
  ggrepel::geom_text_repel(
    ggplot2::aes(label = flavor),
    data = \(d) dplyr::slice_max(d, order_by = date, by = flavor),
    direction = "y",
    nudge_x = 100,
    segment.size = 0.2,
    segment.alpha = 0.5
  ) +
  ggplot2::theme_minimal() +
  ggplot2::guides(colour = "none", size = "none")
```

CRAN上のRustは半年以上1.81.0から動いていない。

# 技術的な話

## Arrow型対応

::: {.incremental}

- Apache Arrowの型の一部は、Base Rのベクトルで表現できない
  - Null
  - Time
  - Binary
- S3ベクトルを良い感じに定義できるvctrsパッケージおよび  
  vctrsに基づいたいくつかのパッケージでかなり対応できる
  - `vctrs::unspecified()`
  - `hms::hms()`
  - `blob::blob()`

:::

## Arrow型対応

日時型のパッケージとして最も表現力の高い（※私調べ）  
clockパッケージをサポートしているのは現時点でpolarsのみ

```r
clock::naive_time_parse(
  c(
    NA,
    "1900-01-01T12:34:56.123456789",
    "2020-01-01T12:34:56.123456789"
  ),
  precision = "nanosecond"
) |>
  polars::as_polars_series()
```

## mirai統合 / reticulate統合

- mirai：別のRセッション（同一マシン/別マシン）に  
  polarsオブジェクトを転送する
- reticulate：Pythonにpolarsオブジェクトを転送する

. . .

- 計算能力の高いマシンにクエリを転送？
- バックグラウンド実行？
- Python Polarsにしかない関数の実行？

## S7への移行

新しくて単純なクラスのS7への移行から開始

従来のpolarsオブジェクト：環境型にS3クラス属性を付けたもの

```r
function(x, ...) {
  self <- new.env(parent = emptyenv())
  self$`_df` <- x

  class(self) <- c("polars_data_frame", "polars_object")
  self
}
```

. . .

- 利点
  - 単純、依存関係なし
- 欠点
  - `is.environment()`が`TRUE`になる

---

## 環境型の限界

```{r}
#| error: true
plot(polars::as_polars_df(mtcars))
```

↑のように謎のエラーが発生し、`plot()`関数を使えない！

. . .

- 関数内で`is.environment()`による判定が行われており、`as.data.frame()`まで到達できない
  - arrowパッケージのクラスでも同じ

---

## 多重ディスパッチ

:::: {.columns}

::: {.column width="50%"}

演算子

```r
s <- polars::as_polars_series(1L)
e <- polars::as_polars_expr(1L)

s + 1 # 2 (Series)
e + 1 # 2 (Expr)

s + e # エラー
e + s # エラー
```

:::

::: {.column width="50%"}

複雑な関数

```r
df <- polars::as_polars_df(mtcars)

df[, 1]
df[1]
df[, "mpg"]
df["mpg"]
```

:::

::::

. . .

S7を採用することで良い感じに書けるようになりそう

---

## まとめ

今日はPolarsという名前だけでも覚えて帰ってください

. . .

ついでに気軽にインストールして試してみてください！
